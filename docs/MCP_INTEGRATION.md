# MCP Integration Guide - Palentir OSINT\n\n## Overview\n\nThe Palentir OSINT platform integrates multiple Model Context Protocol (MCP) tools through a modular toolkit architecture. This allows agents to access external OSINT data sources seamlessly.\n\n## Architecture\n\n### Component Hierarchy\n\n```\nAgents\n  ↓\nAgentToolIntegration (agent_tools.py)\n  ↓\nToolkitRegistry (registry.py)\n  ↓\nToolkits (network_toolkit.py, social_toolkit.py, image_toolkit.py)\n  ↓\nClients (shodan_client.py, dns_twist_client.py, social_media_client.py, image_search_client.py)\n  ↓\nExternal APIs (Shodan, DNS Twist, Twitter, LinkedIn, GitHub, Google Images)\n```\n\n## Integrated Tools\n\n### 1. Network Toolkit\n\n**Location**: `src/toolkits/network_toolkit.py`\n\n**Clients**:\n- **ShodanClient** (`src/clients/shodan_client.py`)\n  - Search Shodan database\n  - Host lookup\n  - DNS lookup\n  - Reverse DNS\n  - Account profile\n\n- **DNSTwistClient** (`src/clients/dns_twist_client.py`)\n  - Domain enumeration\n  - Typosquatting detection\n  - Registered domain filtering\n\n**Tools Available**:\n```python\n- shodan_search(query, page, limit)\n- shodan_host_lookup(ip)\n- shodan_dns_lookup(domain)\n- dns_twist_enumerate(domain, registered_only, limit)\n- dns_twist_typosquatting(domain)\n```\n\n**Assigned Agents**:\n- NetworkAnalyzerAgent\n- GraphBuilderAgent\n\n### 2. Social Toolkit\n\n**Location**: `src/toolkits/social_toolkit.py`\n\n**Client**: **SocialMediaClient** (`src/clients/social_media_client.py`)\n\n**Supported Platforms**:\n- Twitter (search, user lookup)\n- LinkedIn (people, companies)\n- GitHub (users, repositories)\n- Instagram (limited API)\n\n**Tools Available**:\n```python\n- twitter_search(query, max_results)\n- twitter_user_lookup(username)\n- linkedin_search_people(query)\n- linkedin_search_companies(query)\n- github_search_users(query)\n- github_search_repos(query)\n- instagram_search(query)\n```\n\n**Assigned Agents**:\n- SocialFinderAgent\n- GraphBuilderAgent\n\n### 3. Image Toolkit\n\n**Location**: `src/toolkits/image_toolkit.py`\n\n**Client**: **ImageSearchClient** (`src/clients/image_search_client.py`)\n\n**Capabilities**:\n- Image search by query\n- Reverse image search\n- Image metadata extraction\n- Company logo search\n- Website screenshot search\n\n**Tools Available**:\n```python\n- image_search(query, limit)\n- reverse_image_search(image_url)\n- extract_image_metadata(image_url)\n- search_company_logos(company_name, limit)\n- search_website_screenshots(domain, limit)\n```\n\n**Assigned Agents**:\n- TechDetectorAgent\n\n## Usage Examples\n\n### 1. Direct Toolkit Usage\n\n```python\nfrom src.toolkits import get_toolkit_registry\n\nregistry = get_toolkit_registry()\n\n# Execute a tool\nresult = await registry.execute_tool(\n    toolkit_name=\"NetworkToolkit\",\n    tool_name=\"shodan_search\",\n    query=\"apache\",\n    page=1,\n    limit=100\n)\n```\n\n### 2. Agent-Based Tool Usage\n\n```python\nfrom src.agents import EnhancedNetworkAnalyzerAgent\n\nagent = EnhancedNetworkAnalyzerAgent()\n\n# Analyze domain with all network tools\nresults = await agent.analyze_domain(\"example.com\")\n```\n\n### 3. Tool Discovery\n\n```python\nfrom src.agents import get_agent_tool_integration\n\nintegration = get_agent_tool_integration()\n\n# Get tools available to an agent\ntools = integration.get_agent_tools(\"NetworkAnalyzerAgent\")\n\n# Get tool schemas\nschemas = integration.get_agent_tool_schemas(\"NetworkAnalyzerAgent\")\n\n# Get complete registry schema\nschema = integration.get_registry_schema()\n```\n\n## Configuration\n\n### Environment Variables\n\nAdd to `.env`:\n\n```bash\n# Shodan\nSHODAN_API_KEY=your_shodan_api_key\n\n# Twitter\nTWITTER_BEARER_TOKEN=your_twitter_bearer_token\n\n# LinkedIn\nLINKEDIN_TOKEN=your_linkedin_token\n\n# Google Images (optional)\nGOOGLE_CUSTOM_SEARCH_API_KEY=your_key\nGOOGLE_CUSTOM_SEARCH_ENGINE_ID=your_engine_id\n```\n\n### Settings Configuration\n\nUpdate `src/config/settings.py`:\n\n```python\nclass Settings(BaseSettings):\n    # OSINT Tools\n    shodan_api_key: Optional[str] = Field(default=None, env=\"SHODAN_API_KEY\")\n    twitter_bearer_token: Optional[str] = Field(default=None, env=\"TWITTER_BEARER_TOKEN\")\n    linkedin_token: Optional[str] = Field(default=None, env=\"LINKEDIN_TOKEN\")\n```\n\n## Extending the System\n\n### Adding a New Toolkit\n\n1. **Create a new client** in `src/clients/`:\n\n```python\nclass NewClient:\n    async def search(self, query: str) -> Dict[str, Any]:\n        # Implementation\n        pass\n```\n\n2. **Create a new toolkit** in `src/toolkits/`:\n\n```python\nfrom .base_toolkit import BaseToolkit\n\nclass NewToolkit(BaseToolkit):\n    def __init__(self, client):\n        self.client = client\n        super().__init__(name=\"NewToolkit\", description=\"...\")\n    \n    def _initialize_tools(self):\n        self.register_tool(\n            name=\"tool_name\",\n            description=\"...\",\n            func=self._tool_func,\n            parameters={...},\n            required=[...]\n        )\n    \n    async def _tool_func(self, **kwargs):\n        # Implementation\n        pass\n```\n\n3. **Register in toolkit registry** in `src/toolkits/registry.py`:\n\n```python\ndef _initialize_default_toolkits(self):\n    self.register_toolkit(NewToolkit())\n```\n\n4. **Map to agents** in `src/agents/agent_tools.py`:\n\n```python\nself.agent_tools[\"AgentName\"] = [\"tool_name\"]\n```\n\n### Adding a New Agent Tool\n\n1. **Create enhanced agent** in `src/agents/enhanced_workers.py`:\n\n```python\nclass EnhancedNewAgent(BaseOSINTAgent):\n    async def process_data(self, data):\n        result = await self.toolkit_registry.execute_tool(\n            \"ToolkitName\",\n            \"tool_name\",\n            **kwargs\n        )\n        return result\n```\n\n2. **Update agent tools mapping**:\n\n```python\nself.agent_tools[\"EnhancedNewAgent\"] = [\"tool_name\"]\n```\n\n## Data Flow\n\n### Example: Network Analysis\n\n```\nUser Request\n    ↓\nTaskOrchestratorAgent\n    ↓\nDecomposes into subtasks\n    ↓\nEnhancedNetworkAnalyzerAgent\n    ↓\nAgentToolIntegration.execute_agent_tool()\n    ↓\nToolkitRegistry.execute_tool()\n    ↓\nNetworkToolkit.execute_tool()\n    ↓\nShodanClient / DNSTwistClient\n    ↓\nExternal API (Shodan / DNS Twist)\n    ↓\nResults returned and processed\n    ↓\nGraphBuilderAgent (stores in Neo4j)\n    ↓\nMemoryAgent (stores in Qdrant)\n```\n\n## Error Handling\n\nAll tools return a standardized response format:\n\n```python\n{\n    \"status\": \"success\" | \"error\",\n    \"error\": \"error message if failed\",\n    \"results\": {...}  # Tool-specific results\n}\n```\n\n## Rate Limiting\n\nImplement rate limiting in clients:\n\n```python\nfrom aiolimiter import AsyncLimiter\n\nclass RateLimitedClient:\n    def __init__(self):\n        self.limiter = AsyncLimiter(max_rate=10, time_period=60)\n    \n    async def request(self):\n        async with self.limiter:\n            # Make request\n            pass\n```\n\n## Caching\n\nCache tool results in Redis:\n\n```python\nfrom src.services import get_redis_service\n\nredis = await get_redis_service()\nawait redis.set(f\"tool:{tool_name}:{params_hash}\", result, ttl=3600)\n```\n\n## Testing\n\n### Unit Tests\n\n```python\nimport pytest\n\n@pytest.mark.asyncio\nasync def test_shodan_search():\n    client = ShodanClient(api_key=\"test_key\")\n    result = await client.search(\"apache\")\n    assert result[\"status\"] == \"success\"\n```\n\n### Integration Tests\n\n```python\n@pytest.mark.asyncio\nasync def test_agent_tool_execution():\n    integration = get_agent_tool_integration()\n    result = await integration.execute_agent_tool(\n        \"NetworkAnalyzerAgent\",\n        \"shodan_search\",\n        query=\"apache\"\n    )\n    assert result[\"status\"] == \"success\"\n```\n\n## Monitoring\n\nLog tool execution:\n\n```python\nlogger.info(f\"Executing tool: {tool_name}\")\nlogger.debug(f\"Tool parameters: {kwargs}\")\nlogger.info(f\"Tool result: {result}\")\n```\n\n## Performance Optimization\n\n1. **Parallel execution**: Execute multiple tools simultaneously\n2. **Caching**: Cache results for repeated queries\n3. **Rate limiting**: Respect API rate limits\n4. **Batch operations**: Process multiple items in one request\n5. **Connection pooling**: Reuse HTTP connections\n\n## Security Considerations\n\n1. **API Key Management**: Store keys in environment variables\n2. **Input Validation**: Validate all tool parameters\n3. **Output Sanitization**: Sanitize results before storage\n4. **Access Control**: Restrict tool access by agent role\n5. **Audit Logging**: Log all tool executions\n\n## Troubleshooting\n\n### Tool Not Found\n\n```python\n# Check available tools\ntools = registry.get_all_tools()\nprint(tools)\n```\n\n### Agent Cannot Access Tool\n\n```python\n# Check agent-tool mapping\nintegration = get_agent_tool_integration()\ntools = integration.get_agent_tools(\"AgentName\")\nprint(tools)\n```\n\n### API Authentication Failed\n\n```python\n# Verify credentials\nprofile = await shodan_client.get_profile()\nif \"error\" in profile:\n    print(\"Invalid API key\")\n```\n\n## Future Enhancements\n\n- [ ] Add Censys integration\n- [ ] Add Wayback Machine integration\n- [ ] Add VirusTotal integration\n- [ ] Add Shodan Honeypot integration\n- [ ] Add Censys ASM integration\n- [ ] Add Passive DNS integration\n- [ ] Add Whois integration\n- [ ] Add GeoIP integration\n- [ ] Add SSL certificate monitoring\n- [ ] Add Email verification\n\n## References\n\n- [Shodan API Documentation](https://developer.shodan.io/)\n- [DNS Twist GitHub](https://github.com/elceef/dnstwist)\n- [Twitter API Documentation](https://developer.twitter.com/)\n- [LinkedIn API Documentation](https://docs.microsoft.com/en-us/linkedin/)\n- [GitHub API Documentation](https://docs.github.com/en/rest)\n- [Model Context Protocol](https://modelcontextprotocol.io/)\n"
